# GitHub Actions 工作流 - 自动构建和打包
name: Build and Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # 允许手动触发
  workflow_dispatch:

jobs:
  # ==================== macOS Apple Silicon 构建 ====================
  build-macos-arm64:
    runs-on: macos-14  # M1 runner
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: 显示环境信息
        run: |
          echo "=== 系统架构 ==="
          uname -m
          echo "=== Python 版本 ==="
          python --version
          echo "=== PyInstaller 版本 ==="
          pyinstaller --version

      - name: 构建应用
        run: |
          # 使用 spec 文件打包
          pyinstaller BongoCultivator-mac-applesilicon.spec --noconfirm

      - name: 验证构建产物
        run: |
          echo "=== 检查构建产物 ==="
          ls -la dist/
          echo "=== 检查可执行文件架构 ==="
          file dist/BongoCultivator.app/Contents/MacOS/BongoCultivator

      - name: 压缩应用
        run: |
          cd dist
          zip -r ../BongoCultivator-macOS-AppleSilicon.zip BongoCultivator.app

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: BongoCultivator-macOS-AppleSilicon
          path: BongoCultivator-macOS-AppleSilicon.zip
          retention-days: 30

  # ==================== macOS Intel 构建 ====================
  build-macos-intel:
    runs-on: macos-15-intel  # Intel runner (macos-13 已废弃)
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: 显示环境信息
        run: |
          echo "=== 系统架构 ==="
          uname -m
          echo "=== Python 版本 ==="
          python --version
          echo "=== PyInstaller 版本 ==="
          pyinstaller --version

      - name: 构建应用
        run: |
          # 使用 spec 文件打包
          pyinstaller BongoCultivator-mac-applesilicon.spec --noconfirm

      - name: 验证构建产物
        run: |
          echo "=== 检查构建产物 ==="
          ls -la dist/
          echo "=== 检查可执行文件架构 ==="
          file dist/BongoCultivator.app/Contents/MacOS/BongoCultivator

      - name: 压缩应用
        run: |
          cd dist
          zip -r ../BongoCultivator-macOS-Intel.zip BongoCultivator.app

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: BongoCultivator-macOS-Intel
          path: BongoCultivator-macOS-Intel.zip
          retention-days: 30

  # ==================== Windows 构建 ====================
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: 构建应用
        run: |
          # 使用 spec 文件打包
          pyinstaller BongoCultivator-win.spec --noconfirm

      - name: 压缩应用
        run: |
          Compress-Archive -Path dist/BongoCultivation.exe -DestinationPath BongoCultivator-Windows.zip

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: BongoCultivator-Windows
          path: BongoCultivator-Windows.zip
          retention-days: 30

  # ==================== 测试运行 ====================
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # 安装虚拟显示器用于 GUI 测试
          sudo apt-get update
          sudo apt-get install -y xvfb libxcb-xinerama0 libxcb-cursor0

      - name: 验证数据文件
        run: |
          # 验证数据文件可以正常加载
          python -c "
          import json
          
          print('测试数据文件加载...')
          
          with open('src/data/items.json', 'r', encoding='utf-8') as f:
              items = json.load(f)
              print(f'  ✅ items.json: {len(items)} 个物品')
          
          with open('src/data/events.json', 'r', encoding='utf-8') as f:
              events = json.load(f)
              print(f'  ✅ events.json: {len(events)} 个事件')
          
          with open('src/data/dialogues.json', 'r', encoding='utf-8') as f:
              dialogues = json.load(f)
              print(f'  ✅ dialogues.json: 加载成功')
          
          print('✅ 所有数据文件验证通过！')
          "

      - name: 测试结果
        run: |
          echo "✅ 所有测试通过！"

# Plan 14: 轮回继承与转世重修系统 (Legacy System) - DONE

## 目标
实现角色“身死道消”或“兵解重修”后的资源继承机制，使玩家在重新开始时能够保留部分积累，体验 Rogue-lite 式的成长循环。解决用户提出的“加点和属性继承”需求。

## 1. 核心概念

### 1.1 触发方式
1.  **身死道消 (Accidental Death)**
    *   **触发**: 渡劫失败且生命值归零（未触发保命道具）。
    *   **惩罚**: 继承比例较低。
2.  **兵解重修 (Voluntary Rebirth)**
    *   **触发**: 玩家在界面主动选择（通常需达到一定境界，如金丹期以上）。
    *   **奖励**: 继承比例较高，且可能有额外“悟道”奖励。

### 1.2 继承资源：气运 (Legacy Points)
*   **定义**: 这是一个独立于单次存档的全局资源，或者在新存档生成时注入的初始资源。
*   **来源**:
    *   根据前一世的 **最高境界**。
    *   根据前一世的 **总自由属性点投入**。
    *   根据前一世的 **成就/功德值**。

## 2. 详细设计规则

### 2.1 属性点继承规则 (用户核心需求)
为了防止数值无限膨胀，采用**“转化-折损-返还”**机制。

*   **记录**: 记录玩家历史投入到 (体魄/力量/敏捷...) 的总自由点数 `Total_AP`。
*   **转化公式**:
    *   `New_Free_AP (新开局自由点)` = `Base_AP (初始)` + `Inherited_AP`
    *   `Inherited_AP` = `Total_AP` * `Rate`
*   **继承率 (Rate)**:
    *   **身死**: 30% - 50% (取决于是否有“护道”类道具)。
    *   **重修**: 80% - 100% (鼓励达到瓶颈后重修)。
*   **上限限制**: 每一世能够继承的点数有上限（受限于“灵魂强度”），灵魂强度可以通过多次转世提升。

## 3. 实现步骤

### Phase 1: 数据结构升级 (Completed)
1.  **修改 `PlayerData`**: 增加 `death_count` (转世次数), `legacy_points` (继承点数)。
2.  **修改 `save_data.json`**:
    *   除了当前的 `cultivator` 字段，增加 `legacy` 字段存储全局积累。

### Phase 2: 结算逻辑 (`ReincarnationManager`) (Completed)
1.  创建 `src/services/reincarnation_manager.py`。
2.  实现 `calculate_legacy(cultivator, reason)` 方法，返回继承数据。

### Phase 3: 死亡与重生流程 (Completed)
1.  **死亡弹窗**: 当 HP <= 0 且无复活手段 -> 弹出“轮回结算界面”。
2.  **结算界面**: 展示本世生平（存活时间、最高境界），计算获得加成。
3.  **新游戏初始化**:
    *   修改 `Cultivator.__init__` 或 `load_data`，支持传入 `legacy_data`。
    *   在初始化属性时，叠加上一世的 `Inherited_AP`。

### Phase 4: UI 支持 (Completed)
1.  **人才(属性)面板**: 显示“先天属性”和“后天投入”的区别。
2.  **设置/系统菜单**: 增加“兵解重修”按钮（带二次确认）。

## 4. 示例数值
*   玩家 A (金丹期) 死了。他生前分配了 100 点自由属性。
    *   身死继承率 40%。
    *   下一世开局，直接获得 40 点自由属性点。
*   玩家 B (化神期) 主动重修。他生前分配了 500 点。
    *   重修继承率 90%。
    *   下一世开局，直接获得 450 点自由属性点（直接起飞）。

## 5. 补充规则
按比例折算为少量初始灵石，都是所有物品（清空背包）。

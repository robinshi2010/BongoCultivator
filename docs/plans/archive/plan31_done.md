# Plan 31: 动态对话系统 (Dynamic Dialogue System)

## 📌 目标 (Objective)

将小人点击互动的对话内容从代码硬编码迁移至数据库，并实现基于上下文（境界、状态、行为）的动态对话系统。
这能让角色更鲜活，例如在心魔高时说疯话，在练气期说萌新发言，在大乘期说高深语录。

---

## 🛠️ 执行步骤 (Implementation Steps)

### Phase 1: 数据库设计 (Schema Design)

在 `user_data.db` 中新建表 `dialogue_definitions`：
- `id` (TEXT, PK): 唯一标识 (e.g., `dia_common_01`)
- `text` (TEXT): 对话内容
- `type` (TEXT): 类型 (common, realm, state)
- `conditions_json` (TEXT): 触发条件 (JSON)，例如 `{"min_layer": 0, "max_layer": 2, "min_mind": 50, "min_clicks": 10000}`
- `weight` (INTEGER): 随机权重

### Phase 2: 对话内容设计 (Content Design)

设计三大类对话数据：

1.  **通用 (Common)**: 所有阶段均可触发。
    - "道友，今天也要加油修仙哦。"
    - "摸摸头会长不高的..."
2.  **境界专属 (Realm Specific)**:
    - **炼气期 (Lv0)**: 
        - "灵气...这里的灵气太稀薄了。"
        - "我要努力筑基，从此不再是凡人！"
        - "这引气入体怎么这么难？"
    - **筑基期 (Lv1)**:
        - "筑成大道之基，方知仙途漫漫。"
        - "这点法力，也就够点个灯的。"
    - **金丹期 (Lv2)**:
        - "一粒金丹吞入腹，我命由我不由天！"
        - "金丹九转，每一转都是一次蜕变。"
    - **元婴期 (Lv3)**:
        - "元神出窍，遨游太虚...咦，那是什么？"
        - "区区心魔，何足挂齿，给我破！"
    - **化神期 (Lv4)**:
        - "天地与我并生，而万物与我为一。"
        - "这种境界...凡人是不会懂的。"
    - **合体/渡劫/大乘 (Lv5+)**:
        - "天劫将至，道友可愿助我一臂之力？"
        - "不论成仙成魔，我自一剑斩之！"
        - "这世间法则，在我眼中已如掌纹般清晰。"

3.  **状态专属 (State Specific)**:
    - **高心魔 (>50)**: 
        - "别吵！让我静静..."
        - "为什么...他们都要害我？"
    - **极高心魔 (>80)**:
        - "杀...杀尽天下负心人..."
        - "我是谁？我在哪？我是不是已经死了？"
        - "嘿嘿嘿...这血红色的月亮真好看..."
    - **高勤勉 (点击>5000)**: 
        - "道友手速惊人，定是单身多年！"
    - **极高勤勉 (点击>10000)**: 
        - "别点了...要...要坏掉了！"
        - "你是触手怪转世吗？恐怖如斯！"
    - **摸鱼 (IDLE)**: 
        - "呼...还是躺着舒服。"
        - "修行之道，一张一弛。今天就休息吧。"
        - "ZZZ...道涨魔消...ZZZ..."
    - **斗法 (COMBAT)**:
        - "吃我一记雷法！"
        - "妖孽！哪里跑！"
        - "我这一剑下去，你可能会死。"
    - **炼丹 (WORK)**:
        - "火候到了，开炉！"
        - "这炉丹药要是炸了，我就破产了..."

### Phase 3: 逻辑实现 (Logic Implementation)

1.  **数据管理器**: 在 `Cultivator` 或 `ItemManager` (或新建 `DialogueManager`) 中加载对话缓存。
2.  **筛选逻辑**:
    - `get_random_dialogue(player_state)` 方法。
    - 遍历所有对话，检查 `conditions_json` 是否满足当前玩家状态 (`layer`, `mind`, `today_clicks` 等)。
    - 从满足条件的候选中，根据 `weight` 随机抽取。

### Phase 4: 数据同步与版本控制 (Data Sync & Migration)

为防止更新覆盖存档，需在 `DataLoader.load_initial_data` 中增加逻辑：
1.  **检查表是否存在**: 不存在则创建。
2.  **增量更新 (Upsert)**: 读取最新的 JSON 配置 (将在 `src/data/dialogues.json` 中维护)，与数据库对比。
    - 如果 ID 不存在 -> 插入。
    - 如果 ID 存在 -> 更新文本/条件 (保证配置更新能应用到旧存档)。
    - **关键**: 绝不删除用户可能自定义的数据（如果未来支持自定义），也不重置表。

---

## ✅ 验收标准 (Acceptance Criteria)

1.  **数据独立**: 源码中不再包含硬编码的对话列表。
2.  **动态响应**:
    - 炼气期玩家不仅能看到通用对话，还能看到炼气期专属对话。
    - 修改存档心魔值到 90，点击小人应出现“疯言疯语”。
3.  **更新安全**:
    - 运行程序后，数据库自动生成 `dialogue_definitions` 表并填充数据。
    - 原有 `player_status` 和 `inventory` 数据不受影响。
